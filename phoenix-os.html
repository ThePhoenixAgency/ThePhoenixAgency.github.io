<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>PhoenixOS v2.1.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;overflow:hidden;height:100vh;background:#000}

/* Boot Screen */
#bootScreen{position:fixed;inset:0;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10000;transition:opacity 0.5s}
#bootScreen.hidden{opacity:0;pointer-events:none}
.boot-logo{font-size:80px;animation:pulse 2s infinite}
.boot-text{color:#fff;font-size:18px;margin:10px;font-weight:300;opacity:0.8}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
#bootProgress{color:#00ff00;font-family:monospace;margin-top:20px}

/* Login Screen */
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,#667eea,#764ba2);display:none;align-items:center;justify-content:center;z-index:9999}
#loginScreen.show{display:flex}
.login-box{background:rgba(255,255,255,0.95);padding:40px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;max-width:350px;width:90%}
.login-box h2{margin-bottom:20px;color:#333}
.login-input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;margin:10px 0;transition:border 0.3s}
.login-input:focus{border-color:#667eea;outline:none}
.login-btn{width:100%;padding:12px;background:#667eea;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;margin-top:10px;transition:background 0.3s}
.login-btn:hover{background:#5568d3}

/* Desktop */
#desktop{height:100vh;display:none;flex-direction:column;background:linear-gradient(135deg,#667eea,#764ba2)}
#desktop.show{display:flex}

/* Menubar */
.menubar{height:32px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);display:flex;align-items:center;padding:0 12px;gap:12px;font-size:14px;box-shadow:0 1px 3px rgba(0,0,0,0.1);z-index:1000}
.menubar-item{cursor:pointer;padding:6px 10px;border-radius:4px;transition:background 0.2s;user-select:none}
.menubar-item:hover{background:rgba(0,0,0,0.05)}
.menubar-right{margin-left:auto;display:flex;gap:12px;align-items:center}

/* Desktop Icons */
.desktop-content{flex:1;padding:20px;overflow:hidden;position:relative}
.desktop-icons{display:grid;grid-template-columns:repeat(auto-fill,90px);gap:15px;align-content:start}
.desktop-icon{width:80px;text-align:center;cursor:pointer;padding:10px;border-radius:8px;transition:background 0.2s;user-select:none}
.desktop-icon:hover{background:rgba(255,255,255,0.2)}
.desktop-icon-img{font-size:48px;margin-bottom:5px}
.desktop-icon-label{color:#fff;font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,0.5)}

/* Taskbar */
.taskbar{height:60px;background:rgba(255,255,255,0.3);backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:center;gap:8px;padding:0 10px;border-top:1px solid rgba(255,255,255,0.2)}
.taskbar-item{width:50px;height:50px;background:rgba(255,255,255,0.9);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:transform 0.2s,background 0.2s;user-select:none}
.taskbar-item:hover{transform:translateY(-5px);background:#fff}
.taskbar-item.active{background:#667eea;transform:translateY(-5px)}

/* Windows */
.window{position:absolute;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:none;flex-direction:column;min-width:400px;min-height:300px;overflow:hidden}
.window.show{display:flex}
.window.maximized{top:32px!important;left:0!important;width:100%!important;height:calc(100vh - 32px - 60px)!important;border-radius:0!important}
.window-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:12px;display:flex;align-items:center;cursor:move;user-select:none}
.window-title{font-weight:600;flex:1;text-align:center;font-size:14px}
.window-controls{display:flex;gap:8px;position:absolute;left:12px}
.window-btn{width:12px;height:12px;border-radius:50%;cursor:pointer;border:1px solid rgba(255,255,255,0.3);transition:transform 0.1s}
.window-btn:hover{transform:scale(1.1)}
.window-btn.close{background:#FF3B30}
.window-btn.minimize{background:#FFCC00}
.window-btn.maximize{background:#34C759}
.window-body{flex:1;overflow:auto;position:relative}
.window-resize{position:absolute;bottom:0;right:0;width:20px;height:20px;cursor:nwse-resize;z-index:10}

/* On-Screen Keyboard */
#osk{position:fixed;bottom:60px;left:0;right:0;background:rgba(240,240,245,0.98);backdrop-filter:blur(20px);padding:10px;display:none;z-index:9000;border-top:1px solid #ccc;max-height:180px;overflow:hidden}
#osk.show{display:block}
.osk-row{display:flex;gap:4px;margin:4px 0;justify-content:center}
.osk-key{flex:0 0 auto;min-width:28px;height:38px;background:#fff;border:1px solid #ccc;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;user-select:none;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:background 0.1s,transform 0.1s}
.osk-key:active{background:#e0e0e0;transform:scale(0.95)}
.osk-key.space{flex:1;min-width:100px}
.osk-key.wide{min-width:60px}
.osk-key.shift{min-width:70px}

/* Responsive */
@media (max-width:768px){
  .window{min-width:90vw!important;width:90vw!important}
  .window.maximized{width:100vw!important;height:calc(100vh - 32px - 60px - 180px)!important}
  #osk.show ~ #desktop .window.maximized{height:calc(100vh - 32px - 60px - 180px)!important}
  .desktop-icons{grid-template-columns:repeat(auto-fill,75px);gap:10px}
  .desktop-icon{width:70px}
  .desktop-icon-img{font-size:36px}
  .taskbar{height:55px;gap:6px}
  .taskbar-item{width:44px;height:44px;font-size:22px}
  .menubar{font-size:12px;padding:0 8px;gap:6px}
  .menubar-item{padding:5px 8px}
  .calculator-display{font-size:28px;padding:15px 12px;min-height:70px}
  .calc-btn{padding:16px;font-size:18px}
}

@media (max-width:480px){
  .desktop-icons{grid-template-columns:repeat(auto-fill,65px);gap:8px}
  .desktop-icon{width:60px}
  .desktop-icon-img{font-size:32px}
  .desktop-icon-label{font-size:10px}
  .window-title{font-size:12px}
  .calculator-display{font-size:24px}
  .calc-btn{padding:14px;font-size:16px}
}

/* App-specific styles */
.file-browser{padding:15px;height:100%}
.breadcrumb{display:flex;align-items:center;padding:10px;background:#f5f5f5;border-radius:6px;margin-bottom:15px;flex-wrap:wrap}
.breadcrumb-item{padding:5px 10px;cursor:pointer;border-radius:4px;transition:background 0.2s;user-select:none}
.breadcrumb-item:hover{background:rgba(0,0,0,0.05)}
.breadcrumb-separator{margin:0 5px;opacity:0.5}
.file-list{list-style:none;display:grid;gap:8px}
.file-item{padding:12px;border:1px solid #e0e0e0;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.2s,border-color 0.2s}
.file-item:hover{background:#f9f9f9;border-color:#667eea}
.file-icon{font-size:24px}
.file-info{flex:1}
.file-name{font-weight:500}
.file-date{font-size:12px;color:#666;margin-top:2px}
.file-actions{display:flex;gap:5px}
.btn{padding:6px 12px;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:background 0.2s}
.btn:hover{background:#5568d3}
.btn.danger{background:#FF3B30}
.btn.danger:hover{background:#e02818}
.btn.success{background:#34C759}
.btn.success:hover{background:#2ab84a}
input,textarea{padding:10px;border:2px solid #e0e0e0;border-radius:6px;font-size:14px;font-family:inherit;transition:border-color 0.2s}
input:focus,textarea:focus{outline:none;border-color:#667eea}
.terminal{background:#1a1a1a;color:#00ff00;font-family:'Courier New',monospace;padding:15px;height:100%;overflow-y:auto;font-size:14px}
.terminal-line{margin:3px 0;word-break:break-all}
.terminal-input{background:#1a1a1a;color:#00ff00;border:none;font-family:'Courier New',monospace;width:100%;padding:5px;font-size:14px}
.terminal-input:focus{outline:none}
.calculator{padding:20px;background:#f5f5f5;height:100%}
.calculator-display{background:#fff;padding:20px 15px;border-radius:8px;text-align:right;font-size:32px;font-weight:300;margin-bottom:15px;min-height:80px;display:flex;align-items:center;justify-content:flex-end;box-shadow:0 2px 5px rgba(0,0,0,0.1);word-break:break-all}
.calc-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.calc-btn{padding:20px;background:#fff;border:none;border-radius:8px;font-size:20px;cursor:pointer;transition:background 0.2s,transform 0.1s;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
.calc-btn:hover{background:#f0f0f0}
.calc-btn:active{transform:scale(0.95)}
.calc-btn.operator{background:#667eea;color:#fff}
.calc-btn.operator:hover{background:#5568d3}
.calc-btn.equals{background:#34C759;color:#fff;grid-column:span 2}
.calc-btn.equals:hover{background:#2ab84a}
.notepad{display:flex;flex-direction:column;height:100%;padding:10px}
.notepad textarea{flex:1;border:none;padding:15px;font-family:monospace;font-size:14px;resize:none}
.paint-canvas{display:block;border:2px solid #ddd;cursor:crosshair;touch-action:none;background:#fff}
.paint-controls{padding:10px;background:#f5f5f5;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.color-btn{width:30px;height:30px;border:2px solid #ddd;border-radius:50%;cursor:pointer;transition:transform 0.1s}
.color-btn:hover{transform:scale(1.1)}
.color-btn.active{border-color:#000;border-width:3px}
.game-container{text-align:center;padding:20px}
.game-canvas{border:2px solid #333;margin:10px auto;display:block;background:#000;touch-action:none}
.game-score{font-size:24px;font-weight:bold;margin:10px;color:#667eea}
.game-info{margin:10px;color:#666;font-size:14px}
</style>
</head>
<body>

<!-- Boot Screen -->
<div id="bootScreen">
  <div class="boot-logo">üî•</div>
  <div class="boot-text">PhoenixOS v2.1.0</div>
  <div class="boot-text">Initializing system...</div>
  <div class="boot-text" id="bootProgress">Loading...</div>
</div>

<!-- Login Screen -->
<div id="loginScreen">
  <div class="login-box">
    <div style="font-size:60px;margin-bottom:20px">üî•</div>
    <h2>PhoenixOS</h2>
    <p style="color:#666;margin-bottom:20px;font-size:14px">Enter password to continue</p>
    <input type="password" class="login-input" id="loginPassword" placeholder="Password">
    <button class="login-btn" onclick="handleLogin()">Login</button>
    <div id="loginError" style="color:#FF3B30;margin-top:10px;font-size:13px"></div>
  </div>
</div>

<!-- Desktop -->
<div id="desktop">
  <div class="menubar">
    <div class="menubar-item" style="font-weight:700">üî• PhoenixOS</div>
    <div class="menubar-item" onclick="openAbout()">About</div>
    <div class="menubar-right">
      <div class="menubar-item" id="clock">00:00</div>
      <div class="menubar-item" style="cursor:pointer" onclick="handleShutdown()">‚èª</div>
    </div>
  </div>

  <div class="desktop-content">
    <div class="desktop-icons">
      <div class="desktop-icon" ondblclick="openFiles()">
        <div class="desktop-icon-img">üìÅ</div>
        <div class="desktop-icon-label">Files</div>
      </div>
      <div class="desktop-icon" ondblclick="openTerminal()">
        <div class="desktop-icon-img">‚å®Ô∏è</div>
        <div class="desktop-icon-label">Terminal</div>
      </div>
      <div class="desktop-icon" ondblclick="openEditor()">
        <div class="desktop-icon-img">üìù</div>
        <div class="desktop-icon-label">Notepad</div>
      </div>
      <div class="desktop-icon" ondblclick="openCalculator()">
        <div class="desktop-icon-img">üî¢</div>
        <div class="desktop-icon-label">Calculator</div>
      </div>
      <div class="desktop-icon" ondblclick="openPaint()">
        <div class="desktop-icon-img">üé®</div>
        <div class="desktop-icon-label">Paint</div>
      </div>
      <div class="desktop-icon" ondblclick="openSettings()">
        <div class="desktop-icon-img">‚öôÔ∏è</div>
        <div class="desktop-icon-label">Settings</div>
      </div>
      <div class="desktop-icon" ondblclick="openGames()">
        <div class="desktop-icon-img">üéÆ</div>
        <div class="desktop-icon-label">Games</div>
      </div>
    </div>
  </div>

  <div class="taskbar">
    <div class="taskbar-item" onclick="openFiles()" title="Files">üìÅ</div>
    <div class="taskbar-item" onclick="openTerminal()" title="Terminal">‚å®Ô∏è</div>
    <div class="taskbar-item" onclick="openEditor()" title="Notepad">üìù</div>
    <div class="taskbar-item" onclick="openCalculator()" title="Calculator">üî¢</div>
    <div class="taskbar-item" onclick="openPaint()" title="Paint">üé®</div>
    <div class="taskbar-item" onclick="openGames()" title="Games">üéÆ</div>
  </div>
</div>

<!-- On-Screen Keyboard -->
<div id="osk">
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('1')">1</div>
    <div class="osk-key" onclick="oskType('2')">2</div>
    <div class="osk-key" onclick="oskType('3')">3</div>
    <div class="osk-key" onclick="oskType('4')">4</div>
    <div class="osk-key" onclick="oskType('5')">5</div>
    <div class="osk-key" onclick="oskType('6')">6</div>
    <div class="osk-key" onclick="oskType('7')">7</div>
    <div class="osk-key" onclick="oskType('8')">8</div>
    <div class="osk-key" onclick="oskType('9')">9</div>
    <div class="osk-key" onclick="oskType('0')">0</div>
    <div class="osk-key" onclick="oskBackspace()">‚å´</div>
  </div>
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('q')">q</div>
    <div class="osk-key" onclick="oskType('w')">w</div>
    <div class="osk-key" onclick="oskType('e')">e</div>
    <div class="osk-key" onclick="oskType('r')">r</div>
    <div class="osk-key" onclick="oskType('t')">t</div>
    <div class="osk-key" onclick="oskType('y')">y</div>
    <div class="osk-key" onclick="oskType('u')">u</div>
    <div class="osk-key" onclick="oskType('i')">i</div>
    <div class="osk-key" onclick="oskType('o')">o</div>
    <div class="osk-key" onclick="oskType('p')">p</div>
  </div>
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('a')">a</div>
    <div class="osk-key" onclick="oskType('s')">s</div>
    <div class="osk-key" onclick="oskType('d')">d</div>
    <div class="osk-key" onclick="oskType('f')">f</div>
    <div class="osk-key" onclick="oskType('g')">g</div>
    <div class="osk-key" onclick="oskType('h')">h</div>
    <div class="osk-key" onclick="oskType('j')">j</div>
    <div class="osk-key" onclick="oskType('k')">k</div>
    <div class="osk-key" onclick="oskType('l')">l</div>
  </div>
  <div class="osk-row">
    <div class="osk-key shift" onclick="oskShift()">‚áß</div>
    <div class="osk-key" onclick="oskType('z')">z</div>
    <div class="osk-key" onclick="oskType('x')">x</div>
    <div class="osk-key" onclick="oskType('c')">c</div>
    <div class="osk-key" onclick="oskType('v')">v</div>
    <div class="osk-key" onclick="oskType('b')">b</div>
    <div class="osk-key" onclick="oskType('n')">n</div>
    <div class="osk-key" onclick="oskType('m')">m</div>
  </div>
  <div class="osk-row">
    <div class="osk-key" onclick="oskType('.')">.</div>
    <div class="osk-key" onclick="oskType('@')">@</div>
    <div class="osk-key space" onclick="oskType(' ')">space</div>
    <div class="osk-key" onclick="oskType('-')">-</div>
    <div class="osk-key" onclick="oskType('_')">_</div>
    <div class="osk-key wide" onclick="oskEnter()">‚Üµ</div>
    <div class="osk-key" onclick="toggleOSK()">‚úï</div>
  </div>
</div>

<script>
// System State
let currentOskTarget = null;
let oskShiftActive = false;
let isMobile = window.innerWidth <= 768;
let zIndex = 100;

// File System - Hierarchical with folders
const FS = {
  getData() {
    const data = localStorage.getItem('phoenixos_fs');
    return data ? JSON.parse(data) : {'/': {type: 'folder', items: {}, date: new Date().toISOString()}};
  },
  saveData(data) {
    localStorage.setItem('phoenixos_fs', JSON.stringify(data));
  },
  getPathObj(data, path) {
    if (path === '/') return data['/'];
    const parts = path.split('/').filter(p => p);
    let current = data['/'];
    for (const part of parts) {
      if (!current.items || !current.items[part]) return null;
      current = current.items[part];
    }
    return current;
  },
  mkdir(path, name) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items) return false;
    if (parent.items[name]) return false;
    parent.items[name] = {type: 'folder', items: {}, date: new Date().toISOString()};
    this.saveData(data);
    return true;
  },
  createFile(path, name, content = '') {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items) return false;
    parent.items[name] = {type: 'file', content, date: new Date().toISOString()};
    this.saveData(data);
    return true;
  },
  read(path, name) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items || !parent.items[name]) return null;
    return parent.items[name].content || '';
  },
  update(path, name, content) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items || !parent.items[name]) return false;
    parent.items[name].content = content;
    parent.items[name].date = new Date().toISOString();
    this.saveData(data);
    return true;
  },
  delete(path, name) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    if (!parent || !parent.items || !parent.items[name]) return false;
    delete parent.items[name];
    this.saveData(data);
    return true;
  },
  list(path) {
    const data = this.getData();
    const dir = this.getPathObj(data, path);
    if (!dir || !dir.items) return [];
    return Object.keys(dir.items).map(name => ({
      name,
      type: dir.items[name].type,
      date: dir.items[name].date
    }));
  },
  exists(path, name) {
    const data = this.getData();
    const parent = this.getPathObj(data, path);
    return parent && parent.items && !!parent.items[name];
  }
};

// Boot Sequence
window.onload = function() {
  const bootTexts = [
    'Loading kernel...',
    'Mounting file system...',
    'Starting services...',
    'Initializing hardware...',
    'Ready!'
  ];

  let i = 0;
  const bootInterval = setInterval(() => {
    if (i < bootTexts.length) {
      document.getElementById('bootProgress').textContent = bootTexts[i];
      i++;
    } else {
      clearInterval(bootInterval);
      setTimeout(() => {
        document.getElementById('bootScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('show');
        document.getElementById('loginPassword').focus();
      }, 500);
    }
  }, 600);

  // Login on Enter key
  document.getElementById('loginPassword').addEventListener('keypress', e => {
    if (e.key === 'Enter') handleLogin();
  });
};

function handleLogin() {
  const password = document.getElementById('loginPassword').value;
  const errorDiv = document.getElementById('loginError');

  if (password === 'phoenix') {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('desktop').classList.add('show');
    startClock();
  } else {
    errorDiv.textContent = 'Incorrect password. Hint: phoenix';
    document.getElementById('loginPassword').value = '';
    setTimeout(() => errorDiv.textContent = '', 3000);
  }
}

function handleShutdown() {
  if (!confirm('Shutdown PhoenixOS?')) return;

  document.getElementById('desktop').style.opacity = '0';
  document.getElementById('desktop').style.transition = 'opacity 1s';

  setTimeout(() => {
    document.getElementById('desktop').style.display = 'none';
    document.getElementById('bootScreen').classList.remove('hidden');
    document.getElementById('bootProgress').textContent = 'Shutting down...';

    setTimeout(() => {
      document.body.innerHTML = '<div style="background:#000;color:#fff;height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column"><div style="font-size:80px">üî•</div><div style="margin-top:20px;font-size:20px">PhoenixOS has been shut down</div><div style="margin-top:10px;color:#666;font-size:14px">You can close this window</div></div>';
    }, 2000);
  }, 1000);
}

function startClock() {
  updateClock();
  setInterval(updateClock, 1000);
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
}

// On-Screen Keyboard
function toggleOSK() {
  const osk = document.getElementById('osk');
  osk.classList.toggle('show');
}

function showOSK(target) {
  currentOskTarget = target;
  document.getElementById('osk').classList.add('show');
}

function hideOSK() {
  document.getElementById('osk').classList.remove('show');
  currentOskTarget = null;
}

function oskType(char) {
  if (!currentOskTarget) return;
  const start = currentOskTarget.selectionStart;
  const end = currentOskTarget.selectionEnd;
  const text = currentOskTarget.value;
  const before = text.substring(0, start);
  const after = text.substring(end);

  if (oskShiftActive && char.length === 1) {
    char = char.toUpperCase();
    oskShiftActive = false;
  }

  currentOskTarget.value = before + char + after;
  currentOskTarget.selectionStart = currentOskTarget.selectionEnd = start + char.length;
  currentOskTarget.focus();
}

function oskBackspace() {
  if (!currentOskTarget) return;
  const start = currentOskTarget.selectionStart;
  const end = currentOskTarget.selectionEnd;
  const text = currentOskTarget.value;

  if (start !== end) {
    currentOskTarget.value = text.substring(0, start) + text.substring(end);
    currentOskTarget.selectionStart = currentOskTarget.selectionEnd = start;
  } else if (start > 0) {
    currentOskTarget.value = text.substring(0, start - 1) + text.substring(start);
    currentOskTarget.selectionStart = currentOskTarget.selectionEnd = start - 1;
  }
  currentOskTarget.focus();
}

function oskEnter() {
  if (!currentOskTarget) return;
  if (currentOskTarget.tagName === 'INPUT') {
    const event = new KeyboardEvent('keypress', {key: 'Enter', code: 'Enter', keyCode: 13});
    currentOskTarget.dispatchEvent(event);
  } else {
    oskType('\n');
  }
}

function oskShift() {
  oskShiftActive = !oskShiftActive;
}

// Auto-show OSK on mobile when input focused
if (isMobile) {
  document.addEventListener('focusin', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      setTimeout(() => showOSK(e.target), 100);
    }
  });

  document.addEventListener('focusout', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      setTimeout(() => {
        if (!document.activeElement || (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA')) {
          hideOSK();
        }
      }, 200);
    }
  });
}

// Window Management
function createWindow(title, content, width = 600, height = 400) {
  const win = document.createElement('div');
  win.className = 'window show';

  if (isMobile) {
    win.style.width = '90vw';
    win.style.height = '70vh';
    win.style.top = '60px';
    win.style.left = '5vw';
  } else {
    win.style.width = Math.min(width, window.innerWidth - 100) + 'px';
    win.style.height = Math.min(height, window.innerHeight - 150) + 'px';
    win.style.top = (60 + Math.random() * 50) + 'px';
    win.style.left = (50 + Math.random() * 100) + 'px';
  }

  win.style.zIndex = ++zIndex;

  win.innerHTML = `
    <div class="window-header">
      <div class="window-controls">
        <div class="window-btn close"></div>
        <div class="window-btn minimize"></div>
        <div class="window-btn maximize"></div>
      </div>
      <div class="window-title">${title}</div>
    </div>
    <div class="window-body">${content}</div>
    <div class="window-resize"></div>
  `;

  // Window controls
  win.querySelector('.close').onclick = () => win.remove();
  win.querySelector('.minimize').onclick = () => win.style.display = 'none';
  win.querySelector('.maximize').onclick = () => {
    win.classList.toggle('maximized');
  };

  // Draggable
  const header = win.querySelector('.window-header');
  let isDragging = false, startX, startY, startLeft, startTop;

  const startDrag = (clientX, clientY) => {
    if (win.classList.contains('maximized')) return;
    isDragging = true;
    startX = clientX;
    startY = clientY;
    startLeft = win.offsetLeft;
    startTop = win.offsetTop;
    win.style.zIndex = ++zIndex;
  };

  const doDrag = (clientX, clientY) => {
    if (!isDragging) return;
    win.style.left = (startLeft + clientX - startX) + 'px';
    win.style.top = (startTop + clientY - startY) + 'px';
  };

  const endDrag = () => {
    isDragging = false;
  };

  header.addEventListener('mousedown', e => startDrag(e.clientX, e.clientY));
  header.addEventListener('touchstart', e => {
    const touch = e.touches[0];
    startDrag(touch.clientX, touch.clientY);
  }, {passive: true});

  document.addEventListener('mousemove', e => doDrag(e.clientX, e.clientY));
  document.addEventListener('touchmove', e => {
    if (isDragging) {
      const touch = e.touches[0];
      doDrag(touch.clientX, touch.clientY);
    }
  }, {passive: true});

  document.addEventListener('mouseup', endDrag);
  document.addEventListener('touchend', endDrag);

  // Resizable
  const resizeHandle = win.querySelector('.window-resize');
  let isResizing = false;

  const startResize = (clientX, clientY) => {
    if (win.classList.contains('maximized')) return;
    isResizing = true;
    startX = clientX;
    startY = clientY;
    startLeft = win.offsetWidth;
    startTop = win.offsetHeight;
  };

  const doResize = (clientX, clientY) => {
    if (!isResizing) return;
    const newWidth = startLeft + (clientX - startX);
    const newHeight = startTop + (clientY - startY);
    if (newWidth > 300) win.style.width = newWidth + 'px';
    if (newHeight > 200) win.style.height = newHeight + 'px';
  };

  const endResize = () => {
    isResizing = false;
  };

  resizeHandle.addEventListener('mousedown', e => {
    e.stopPropagation();
    startResize(e.clientX, e.clientY);
  });

  resizeHandle.addEventListener('touchstart', e => {
    e.stopPropagation();
    const touch = e.touches[0];
    startResize(touch.clientX, touch.clientY);
  }, {passive: true});

  document.addEventListener('mousemove', e => doResize(e.clientX, e.clientY));
  document.addEventListener('touchmove', e => {
    if (isResizing) {
      const touch = e.touches[0];
      doResize(touch.clientX, touch.clientY);
    }
  }, {passive: true});

  document.addEventListener('mouseup', endResize);
  document.addEventListener('touchend', endResize);

  document.querySelector('.desktop-content').appendChild(win);
  return win.querySelector('.window-body');
}

// Applications
function openAbout() {
  const body = createWindow('About PhoenixOS', '', 500, 300);
  body.innerHTML = `
    <div style="padding:30px;text-align:center">
      <div style="font-size:80px;margin-bottom:20px">üî•</div>
      <h2 style="margin-bottom:10px">PhoenixOS v2.1.0</h2>
      <p style="color:#666;margin:10px 0">A modern web-based operating system</p>
      <p style="color:#999;font-size:12px;margin-top:20px">Built with HTML, CSS, and JavaScript</p>
      <p style="color:#999;font-size:12px">Features hierarchical file system, OSK, and responsive design</p>
    </div>
  `;
}

// File Browser with hierarchical navigation
function openFiles(startPath = '/') {
  const body = createWindow('Files', '', 700, 500);
  body.innerHTML = `
    <div class="file-browser">
      <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="createNewFile()">New File</button>
        <button class="btn" onclick="createNewFolder()">New Folder</button>
        <button class="btn" onclick="window.currentFilePath && navigateToPath(window.currentFilePath.split('/').slice(0,-1).join('/') || '/')">Up</button>
      </div>
      <div id="fileBreadcrumb"></div>
      <ul class="file-list" id="fileList"></ul>
    </div>
  `;

  window.currentFilePath = startPath;
  renderFileList(body.querySelector('#fileList'), startPath);
}

function renderFileList(container, path) {
  const items = FS.list(path);
  window.currentFilePath = path;

  // Breadcrumb
  const breadcrumb = document.getElementById('fileBreadcrumb');
  if (breadcrumb) {
    const pathParts = path.split('/').filter(p => p);
    let html = '<div class="breadcrumb">';
    html += '<span class="breadcrumb-item" onclick="navigateToPath(\'/\')">üè†</span>';

    let buildPath = '';
    pathParts.forEach((part, i) => {
      buildPath += '/' + part;
      const thisPath = buildPath;
      html += '<span class="breadcrumb-separator">/</span>';
      html += `<span class="breadcrumb-item" onclick="navigateToPath('${thisPath}')">${part}</span>`;
    });

    html += '</div>';
    breadcrumb.innerHTML = html;
  }

  // File list
  container.innerHTML = '';

  if (items.length === 0) {
    container.innerHTML = '<div style="padding:40px;text-align:center;color:#999">Empty folder</div>';
    return;
  }

  items.sort((a, b) => {
    if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
    return a.name.localeCompare(b.name);
  });

  items.forEach(item => {
    const li = document.createElement('li');
    li.className = 'file-item';

    const icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
    const date = new Date(item.date).toLocaleDateString('fr-FR');

    li.innerHTML = `
      <div class="file-icon">${icon}</div>
      <div class="file-info">
        <div class="file-name">${item.name}</div>
        <div class="file-date">${date}</div>
      </div>
      <div class="file-actions">
        ${item.type === 'folder'
          ? `<button class="btn" onclick="navigateToPath('${path === '/' ? '/' + item.name : path + '/' + item.name}')">Open</button>`
          : `<button class="btn" onclick="openFileEditor('${path}', '${item.name}')">Edit</button>`
        }
        <button class="btn danger" onclick="deleteItem('${path}', '${item.name}')">Delete</button>
      </div>
    `;

    if (item.type === 'folder') {
      li.ondblclick = () => navigateToPath(path === '/' ? '/' + item.name : path + '/' + item.name);
    } else {
      li.ondblclick = () => openFileEditor(path, item.name);
    }

    container.appendChild(li);
  });
}

function navigateToPath(path) {
  const container = document.getElementById('fileList');
  if (container) {
    renderFileList(container, path);
  }
}

function createNewFile() {
  const name = prompt('File name:');
  if (!name) return;

  const path = window.currentFilePath || '/';
  if (FS.exists(path, name)) {
    alert('File already exists!');
    return;
  }

  FS.createFile(path, name, '');
  refreshFileList();
}

function createNewFolder() {
  const name = prompt('Folder name:');
  if (!name) return;

  const path = window.currentFilePath || '/';
  if (FS.exists(path, name)) {
    alert('Folder already exists!');
    return;
  }

  FS.mkdir(path, name);
  refreshFileList();
}

function deleteItem(path, name) {
  if (!confirm(`Delete ${name}?`)) return;
  FS.delete(path, name);
  refreshFileList();
}

function refreshFileList() {
  const container = document.getElementById('fileList');
  if (container) {
    renderFileList(container, window.currentFilePath || '/');
  }
}

function openFileEditor(path, filename) {
  const content = FS.read(path, filename) || '';
  const body = createWindow('Edit: ' + filename, '', 700, 500);
  body.innerHTML = `
    <div class="notepad">
      <div style="padding:10px;background:#f5f5f5;border-bottom:1px solid #ddd;display:flex;gap:10px">
        <button class="btn success" onclick="saveCurrentFile()">Save</button>
        <span style="flex:1;display:flex;align-items:center;color:#666;font-size:13px">${path}/${filename}</span>
      </div>
      <textarea id="fileEditorContent" style="flex:1;border:none;padding:15px;font-family:monospace;font-size:14px">${content}</textarea>
    </div>
  `;

  window.currentEditFile = {path, filename};
}

function saveCurrentFile() {
  if (!window.currentEditFile) return;

  const content = document.getElementById('fileEditorContent').value;
  const {path, filename} = window.currentEditFile;

  FS.update(path, filename, content);
  alert('Saved!');
  refreshFileList();
}

// Terminal with cd, mkdir, ls
function openTerminal() {
  const body = createWindow('Terminal', '', 700, 500);
  body.innerHTML = `
    <div style="display:flex;flex-direction:column;height:100%">
      <div class="terminal" id="termOutput">
        <div class="terminal-line">PhoenixOS Terminal v2.1.0</div>
        <div class="terminal-line">Type 'help' for available commands</div>
        <div class="terminal-line"></div>
      </div>
      <div style="background:#1a1a1a;padding:5px;display:flex;align-items:center">
        <span style="color:#00ff00;font-family:monospace;margin-right:5px" id="termPrompt">$ </span>
        <input type="text" class="terminal-input" id="termInput" style="flex:1">
      </div>
    </div>
  `;

  window.termCurrentPath = '/';
  updateTermPrompt();

  const input = document.getElementById('termInput');
  const output = document.getElementById('termOutput');

  input.addEventListener('keypress', e => {
    if (e.key !== 'Enter') return;
    const cmd = input.value.trim();
    input.value = '';

    const promptText = document.getElementById('termPrompt').textContent;
    addTermLine(promptText + cmd);

    if (!cmd) return;
    executeTerminalCommand(cmd, output);
    output.scrollTop = output.scrollHeight;
  });

  input.focus();
}

function updateTermPrompt() {
  const prompt = document.getElementById('termPrompt');
  if (prompt) {
    prompt.textContent = window.termCurrentPath + ' $ ';
  }
}

function addTermLine(text, color = '#00ff00') {
  const output = document.getElementById('termOutput');
  if (!output) return;

  const line = document.createElement('div');
  line.className = 'terminal-line';
  line.style.color = color;
  line.textContent = text;
  output.appendChild(line);
}

function executeTerminalCommand(cmd, output) {
  const parts = cmd.split(' ');
  let response = '';

  switch(parts[0]) {
    case 'help':
      response = 'Available commands:\n  help - Show this help\n  clear - Clear screen\n  ls - List files\n  pwd - Print working directory\n  cd <dir> - Change directory\n  mkdir <name> - Create folder\n  cat <file> - Read file\n  rm <name> - Delete file/folder\n  echo <text> - Print text\n  date - Show date\n  whoami - Current user';
      break;

    case 'clear':
      output.innerHTML = '';
      return;

    case 'ls':
      const items = FS.list(window.termCurrentPath || '/');
      if (items.length === 0) {
        response = 'Empty';
      } else {
        response = items.map(f => (f.type === 'folder' ? 'üìÅ ' : 'üìÑ ') + f.name).join('\n');
      }
      break;

    case 'pwd':
      response = window.termCurrentPath || '/';
      break;

    case 'cd':
      if (!parts[1]) {
        window.termCurrentPath = '/';
        updateTermPrompt();
        return;
      }

      if (parts[1] === '..') {
        const pathParts = window.termCurrentPath.split('/').filter(p => p);
        pathParts.pop();
        window.termCurrentPath = pathParts.length > 0 ? '/' + pathParts.join('/') : '/';
        updateTermPrompt();
        return;
      }

      const newPath = window.termCurrentPath === '/' ? '/' + parts[1] : window.termCurrentPath + '/' + parts[1];
      const data = FS.getData();
      const dir = FS.getPathObj(data, newPath);

      if (dir && dir.type === 'folder') {
        window.termCurrentPath = newPath;
        updateTermPrompt();
        return;
      } else {
        response = 'Directory not found: ' + parts[1];
      }
      break;

    case 'mkdir':
      if (!parts[1]) {
        response = 'Usage: mkdir <folder_name>';
      } else {
        if (FS.mkdir(window.termCurrentPath || '/', parts[1])) {
          response = 'Created folder: ' + parts[1];
        } else {
          response = 'Failed to create folder';
        }
      }
      break;

    case 'cat':
      if (!parts[1]) {
        response = 'Usage: cat <filename>';
      } else {
        const content = FS.read(window.termCurrentPath || '/', parts[1]);
        response = content !== null ? content : 'File not found';
      }
      break;

    case 'rm':
      if (!parts[1]) {
        response = 'Usage: rm <name>';
      } else {
        if (FS.delete(window.termCurrentPath || '/', parts[1])) {
          response = 'Deleted: ' + parts[1];
        } else {
          response = 'Not found: ' + parts[1];
        }
      }
      break;

    case 'echo':
      response = parts.slice(1).join(' ');
      break;

    case 'date':
      response = new Date().toString();
      break;

    case 'whoami':
      response = 'phoenix';
      break;

    default:
      response = 'Command not found: ' + parts[0] + '\nType "help" for available commands';
  }

  if (response) {
    response.split('\n').forEach(line => addTermLine(line));
  }
}

// Notepad
function openEditor() {
  const body = createWindow('Notepad', '', 600, 500);
  body.innerHTML = `
    <div class="notepad">
      <div style="padding:10px;background:#f5f5f5;border-bottom:1px solid #ddd;display:flex;gap:10px">
        <button class="btn" onclick="saveNote()">Save as...</button>
        <button class="btn" onclick="clearNote()">Clear</button>
      </div>
      <textarea id="notepadContent" placeholder="Start typing..."></textarea>
    </div>
  `;
}

function saveNote() {
  const content = document.getElementById('notepadContent').value;
  const filename = prompt('Save as:');
  if (!filename) return;

  FS.createFile('/', filename, content);
  alert('Saved!');
}

function clearNote() {
  document.getElementById('notepadContent').value = '';
}

// Calculator
function openCalculator() {
  const body = createWindow('Calculator', '', 400, 550);
  body.innerHTML = `
    <div class="calculator">
      <div class="calculator-display" id="calcDisplay">0</div>
      <div class="calc-buttons">
        <div class="calc-btn" onclick="calcClear()">C</div>
        <div class="calc-btn" onclick="calcInput('(')">(</div>
        <div class="calc-btn" onclick="calcInput(')')">)</div>
        <div class="calc-btn operator" onclick="calcInput('/')">√∑</div>

        <div class="calc-btn" onclick="calcInput('7')">7</div>
        <div class="calc-btn" onclick="calcInput('8')">8</div>
        <div class="calc-btn" onclick="calcInput('9')">9</div>
        <div class="calc-btn operator" onclick="calcInput('*')">√ó</div>

        <div class="calc-btn" onclick="calcInput('4')">4</div>
        <div class="calc-btn" onclick="calcInput('5')">5</div>
        <div class="calc-btn" onclick="calcInput('6')">6</div>
        <div class="calc-btn operator" onclick="calcInput('-')">‚àí</div>

        <div class="calc-btn" onclick="calcInput('1')">1</div>
        <div class="calc-btn" onclick="calcInput('2')">2</div>
        <div class="calc-btn" onclick="calcInput('3')">3</div>
        <div class="calc-btn operator" onclick="calcInput('+')">+</div>

        <div class="calc-btn" onclick="calcInput('0')">0</div>
        <div class="calc-btn" onclick="calcInput('.')">.</div>
        <div class="calc-btn equals" onclick="calcEquals()">=</div>
      </div>
    </div>
  `;

  window.calcExpression = '';
}

function calcInput(val) {
  const display = document.getElementById('calcDisplay');
  if (!window.calcExpression && display.textContent === '0') {
    window.calcExpression = val;
  } else {
    window.calcExpression += val;
  }
  display.textContent = window.calcExpression || '0';
}

function calcClear() {
  window.calcExpression = '';
  document.getElementById('calcDisplay').textContent = '0';
}

function calcEquals() {
  try {
    const result = eval(window.calcExpression);
    document.getElementById('calcDisplay').textContent = result;
    window.calcExpression = result.toString();
  } catch (e) {
    document.getElementById('calcDisplay').textContent = 'Error';
    window.calcExpression = '';
  }
}

// Paint
function openPaint() {
  const body = createWindow('Paint', '', 700, 600);
  body.innerHTML = `
    <div style="display:flex;flex-direction:column;height:100%">
      <div class="paint-controls">
        <div>
          <div class="color-btn active" style="background:#000" onclick="selectColor('#000', this)"></div>
          <div class="color-btn" style="background:#FF3B30" onclick="selectColor('#FF3B30', this)"></div>
          <div class="color-btn" style="background:#34C759" onclick="selectColor('#34C759', this)"></div>
          <div class="color-btn" style="background:#007AFF" onclick="selectColor('#007AFF', this)"></div>
          <div class="color-btn" style="background:#FFCC00" onclick="selectColor('#FFCC00', this)"></div>
          <div class="color-btn" style="background:#FF9500" onclick="selectColor('#FF9500', this)"></div>
          <div class="color-btn" style="background:#AF52DE" onclick="selectColor('#AF52DE', this)"></div>
        </div>
        <button class="btn" onclick="clearCanvas()">Clear</button>
      </div>
      <div style="flex:1;display:flex;align-items:center;justify-content:center;background:#f5f5f5;padding:10px">
        <canvas id="paintCanvas" class="paint-canvas" width="600" height="400"></canvas>
      </div>
    </div>
  `;

  setupPaint();
}

function setupPaint() {
  const canvas = document.getElementById('paintCanvas');
  const ctx = canvas.getContext('2d');
  let isDrawing = false;
  let currentColor = '#000';

  window.paintColor = currentColor;

  const startDrawing = (x, y) => {
    isDrawing = true;
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  const draw = (x, y) => {
    if (!isDrawing) return;
    ctx.lineTo(x, y);
    ctx.strokeStyle = window.paintColor || '#000';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.stroke();
  };

  const stopDrawing = () => {
    isDrawing = false;
  };

  canvas.addEventListener('mousedown', e => {
    const rect = canvas.getBoundingClientRect();
    startDrawing(e.clientX - rect.left, e.clientY - rect.top);
  });

  canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    draw(e.clientX - rect.left, e.clientY - rect.top);
  });

  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseleave', stopDrawing);

  // Touch support
  canvas.addEventListener('touchstart', e => {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    startDrawing(touch.clientX - rect.left, touch.clientY - rect.top);
  });

  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    draw(touch.clientX - rect.left, touch.clientY - rect.top);
  });

  canvas.addEventListener('touchend', stopDrawing);
}

function selectColor(color, element) {
  window.paintColor = color;
  document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
  element.classList.add('active');
}

function clearCanvas() {
  const canvas = document.getElementById('paintCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// Settings
function openSettings() {
  const body = createWindow('Settings', '', 500, 400);
  body.innerHTML = `
    <div style="padding:20px">
      <h3 style="margin-bottom:20px">System Settings</h3>

      <div style="margin:15px 0;padding:15px;background:#f5f5f5;border-radius:8px">
        <div style="font-weight:600;margin-bottom:5px">File System</div>
        <div style="color:#666;font-size:13px;margin-bottom:10px">Manage stored files and folders</div>
        <button class="btn danger" onclick="clearFileSystem()">Clear All Files</button>
      </div>

      <div style="margin:15px 0;padding:15px;background:#f5f5f5;border-radius:8px">
        <div style="font-weight:600;margin-bottom:5px">Display</div>
        <div style="color:#666;font-size:13px;margin-bottom:10px">Current resolution: ${window.innerWidth}x${window.innerHeight}</div>
        <div style="color:#666;font-size:13px">Mobile mode: ${isMobile ? 'Yes' : 'No'}</div>
      </div>

      <div style="margin:15px 0;padding:15px;background:#f5f5f5;border-radius:8px">
        <div style="font-weight:600;margin-bottom:5px">About</div>
        <div style="color:#666;font-size:13px">PhoenixOS v2.1.0</div>
        <div style="color:#666;font-size:13px">Build: 2025</div>
      </div>
    </div>
  `;
}

function clearFileSystem() {
  if (!confirm('Delete all files and folders? This cannot be undone!')) return;
  localStorage.removeItem('phoenixos_fs');
  alert('File system cleared!');
  refreshFileList();
}

// Games Menu
function openGames() {
  const body = createWindow('Games', '', 500, 400);
  body.innerHTML = `
    <div style="padding:30px">
      <h3 style="margin-bottom:20px;text-align:center">Select a Game</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
        <button class="btn" style="padding:30px;font-size:18px" onclick="playSnake()">üêç<br>Snake</button>
        <button class="btn" style="padding:30px;font-size:18px" onclick="playTicTacToe()">‚≠ï<br>Tic-Tac-Toe</button>
        <button class="btn" style="padding:30px;font-size:18px" onclick="playMemory()">üß†<br>Memory</button>
        <button class="btn" style="padding:30px;font-size:18px" onclick="playPong()">üèì<br>Pong</button>
      </div>
    </div>
  `;
}

// Snake Game
function playSnake() {
  const body = createWindow('Snake', '', 500, 600);
  body.innerHTML = `
    <div class="game-container">
      <div class="game-score" id="snakeScore">Score: 0</div>
      <canvas id="snakeCanvas" class="game-canvas" width="400" height="400"></canvas>
      <div class="game-info">Swipe or use arrow keys to move</div>
    </div>
  `;

  const canvas = document.getElementById('snakeCanvas');
  const ctx = canvas.getContext('2d');
  const grid = 20;
  let snake = [{x: 10, y: 10}];
  let dir = {x: 1, y: 0};
  let food = {x: 15, y: 15};
  let score = 0;
  let gameActive = true;

  // Keyboard controls
  document.addEventListener('keydown', e => {
    if (!gameActive) return;
    if (e.key === 'ArrowUp' && dir.y === 0) dir = {x: 0, y: -1};
    if (e.key === 'ArrowDown' && dir.y === 0) dir = {x: 0, y: 1};
    if (e.key === 'ArrowLeft' && dir.x === 0) dir = {x: -1, y: 0};
    if (e.key === 'ArrowRight' && dir.x === 0) dir = {x: 1, y: 0};
  });

  // Touch controls
  let touchStartX, touchStartY;
  canvas.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, {passive: true});

  canvas.addEventListener('touchend', e => {
    if (!gameActive || !touchStartX || !touchStartY) return;
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const dx = touchEndX - touchStartX;
    const dy = touchEndY - touchStartY;

    if (Math.abs(dx) > Math.abs(dy)) {
      if (dx > 0 && dir.x === 0) dir = {x: 1, y: 0};
      if (dx < 0 && dir.x === 0) dir = {x: -1, y: 0};
    } else {
      if (dy > 0 && dir.y === 0) dir = {x: 0, y: 1};
      if (dy < 0 && dir.y === 0) dir = {x: 0, y: -1};
    }
  }, {passive: true});

  const gameLoop = setInterval(() => {
    if (!gameActive) return;

    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

    if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20 ||
        snake.some(s => s.x === head.x && s.y === head.y)) {
      gameActive = false;
      clearInterval(gameLoop);
      setTimeout(() => alert('Game Over! Score: ' + score), 100);
      return;
    }

    snake.unshift(head);

    if (head.x === food.x && head.y === food.y) {
      score++;
      document.getElementById('snakeScore').textContent = 'Score: ' + score;
      food = {
        x: Math.floor(Math.random() * 20),
        y: Math.floor(Math.random() * 20)
      };
    } else {
      snake.pop();
    }

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, 400, 400);
    ctx.fillStyle = '#34C759';
    snake.forEach(s => ctx.fillRect(s.x * grid, s.y * grid, grid - 2, grid - 2));
    ctx.fillStyle = '#FF3B30';
    ctx.fillRect(food.x * grid, food.y * grid, grid - 2, grid - 2);
  }, 150);
}

// Tic-Tac-Toe
function playTicTacToe() {
  const body = createWindow('Tic-Tac-Toe', '', 400, 500);
  body.innerHTML = `
    <div class="game-container">
      <div class="game-score" id="tttStatus">Your turn (X)</div>
      <div id="tttBoard" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:300px;margin:20px auto">
        ${Array(9).fill(0).map((_, i) => `<div class="calc-btn" style="height:80px;font-size:36px" onclick="tttMove(${i})"></div>`).join('')}
      </div>
      <button class="btn" onclick="playTicTacToe()">New Game</button>
    </div>
  `;

  window.tttBoard = Array(9).fill('');
  window.tttPlayer = 'X';
}

function tttMove(i) {
  if (window.tttBoard[i] || checkTTTWinner()) return;

  window.tttBoard[i] = window.tttPlayer;
  document.querySelectorAll('#tttBoard .calc-btn')[i].textContent = window.tttPlayer;

  const winner = checkTTTWinner();
  if (winner) {
    document.getElementById('tttStatus').textContent = winner === 'tie' ? 'Tie!' : winner + ' wins!';
    return;
  }

  window.tttPlayer = window.tttPlayer === 'X' ? 'O' : 'X';
  document.getElementById('tttStatus').textContent = window.tttPlayer === 'X' ? 'Your turn (X)' : 'AI turn (O)';

  if (window.tttPlayer === 'O') {
    setTimeout(tttAI, 500);
  }
}

function tttAI() {
  const empty = window.tttBoard.map((v, i) => v === '' ? i : -1).filter(i => i >= 0);
  if (empty.length === 0) return;

  const move = empty[Math.floor(Math.random() * empty.length)];
  tttMove(move);
}

function checkTTTWinner() {
  const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for (const [a, b, c] of lines) {
    if (window.tttBoard[a] && window.tttBoard[a] === window.tttBoard[b] && window.tttBoard[a] === window.tttBoard[c]) {
      return window.tttBoard[a];
    }
  }
  return window.tttBoard.every(cell => cell) ? 'tie' : null;
}

// Memory Game
function playMemory() {
  const body = createWindow('Memory', '', 500, 600);

  const emojis = ['üî•', 'üéÆ', 'üé®', 'üéµ', '‚ö°', 'üåü', 'üíé', 'üéØ'];
  const cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);

  body.innerHTML = `
    <div class="game-container">
      <div class="game-score" id="memoryScore">Moves: 0 | Pairs: 0/8</div>
      <div id="memoryBoard" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:400px;margin:20px auto">
        ${cards.map((emoji, i) => `<div class="calc-btn" style="height:80px;font-size:36px" onclick="memoryFlip(${i})" data-emoji="${emoji}">?</div>`).join('')}
      </div>
      <button class="btn" onclick="playMemory()">New Game</button>
    </div>
  `;

  window.memoryFlipped = [];
  window.memoryMatched = [];
  window.memoryMoves = 0;
}

function memoryFlip(i) {
  if (window.memoryFlipped.includes(i) || window.memoryMatched.includes(i) || window.memoryFlipped.length >= 2) return;

  const cards = document.querySelectorAll('#memoryBoard .calc-btn');
  cards[i].textContent = cards[i].dataset.emoji;
  window.memoryFlipped.push(i);

  if (window.memoryFlipped.length === 2) {
    window.memoryMoves++;
    const [a, b] = window.memoryFlipped;

    if (cards[a].dataset.emoji === cards[b].dataset.emoji) {
      window.memoryMatched.push(a, b);
      window.memoryFlipped = [];

      document.getElementById('memoryScore').textContent = `Moves: ${window.memoryMoves} | Pairs: ${window.memoryMatched.length/2}/8`;

      if (window.memoryMatched.length === 16) {
        setTimeout(() => alert(`You won in ${window.memoryMoves} moves!`), 300);
      }
    } else {
      setTimeout(() => {
        cards[a].textContent = '?';
        cards[b].textContent = '?';
        window.memoryFlipped = [];
      }, 1000);
    }

    document.getElementById('memoryScore').textContent = `Moves: ${window.memoryMoves} | Pairs: ${window.memoryMatched.length/2}/8`;
  }
}

// Pong
function playPong() {
  const body = createWindow('Pong', '', 500, 600);
  body.innerHTML = `
    <div class="game-container">
      <div class="game-score" id="pongScore">0 - 0</div>
      <canvas id="pongCanvas" class="game-canvas" width="400" height="400"></canvas>
      <div class="game-info">Move mouse/finger to control</div>
    </div>
  `;

  const canvas = document.getElementById('pongCanvas');
  const ctx = canvas.getContext('2d');
  let ball = {x: 200, y: 200, dx: 3, dy: 3};
  let p1 = {y: 160, score: 0};
  let p2 = {y: 160, score: 0};

  const updatePaddle = (clientY) => {
    const rect = canvas.getBoundingClientRect();
    p1.y = clientY - rect.top - 40;
    p1.y = Math.max(0, Math.min(320, p1.y));
  };

  canvas.addEventListener('mousemove', e => updatePaddle(e.clientY));
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    updatePaddle(e.touches[0].clientY);
  }, {passive: false});

  const gameLoop = setInterval(() => {
    ball.x += ball.dx;
    ball.y += ball.dy;

    if (ball.y < 0 || ball.y > 390) ball.dy *= -1;

    if (ball.x < 20 && ball.y > p1.y && ball.y < p1.y + 80) {
      ball.dx = Math.abs(ball.dx);
      ball.dx *= 1.05;
    }
    if (ball.x > 370 && ball.y > p2.y && ball.y < p2.y + 80) {
      ball.dx = -Math.abs(ball.dx);
    }

    if (ball.x < 0) {
      p2.score++;
      ball = {x: 200, y: 200, dx: 3, dy: 3};
      document.getElementById('pongScore').textContent = p1.score + ' - ' + p2.score;
    }
    if (ball.x > 400) {
      p1.score++;
      ball = {x: 200, y: 200, dx: -3, dy: 3};
      document.getElementById('pongScore').textContent = p1.score + ' - ' + p2.score;
    }

    p2.y += (ball.y - p2.y - 40) * 0.1;

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, 400, 400);
    ctx.fillStyle = '#fff';
    ctx.fillRect(10, p1.y, 10, 80);
    ctx.fillRect(380, p2.y, 10, 80);
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, 8, 0, Math.PI * 2);
    ctx.fill();
  }, 1000/60);
}
</script>
</body>
</html>
