name: Auto Dependencies to Securite Branch

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge-to-securite:
    runs-on: ubuntu-latest
    needs: check-interdependencies
    if: ${{ needs.check-interdependencies.outputs.should_merge == 'true' && (startsWith(github.head_ref, 'dependabot/') || contains(github.head_ref, 'dependencies')) }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Ensure securite branch exists
      run: |
        git fetch origin securite 2>/dev/null || git switch --create securite
        git push origin securite || true

    - name: Merge dependabot changes to securite branch
      run: |
        git config --global user.name 'EthanThePhoenix38'
        git config --global user.email '${{ secrets.GIT_AUTHOR_EMAIL }}'

        # Fetch the PR branch
        git fetch origin ${{ github.head_ref }}:${{ github.head_ref }} || true

        # Switch to securite and merge
        git switch securite
        git merge origin/${{ github.head_ref }} --no-edit || true

        # Push to securite
        git push origin securite

    - name: Auto-approve dependabot PR
      if: ${{ github.actor == 'dependabot[bot]' || startsWith(github.head_ref, 'dependabot/') }}
      run: |
        echo "Dependabot PR detected and merged to securite branch"

  create-pr-to-master:
    needs: auto-merge-to-securite
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: securite
        fetch-depth: 0

    - name: Update Documentation Timestamp
      run: |
        git config --global user.name 'EthanThePhoenix38'
        git config --global user.email '${{ secrets.GIT_AUTHOR_EMAIL }}'
        
        DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
        
        # 1. Update timestamp in README
        sed -i "s/Last updated: .*/Last updated: $DATE/g" README.md || true
        
        # 2. Add entry to CHANGELOG (Under 'Added' section if exists, otherwise append)
        LOG_ENTRY="- **$DATE**: Automated Security Batch Update (DependabotSecureFlow)"
        if [ -f CHANGELOG.md ]; then
           # Try to insert after '### Added' header
           sed -i "/### Added/a $LOG_ENTRY" CHANGELOG.md || echo "$LOG_ENTRY" >> CHANGELOG.md
        fi
        
        # Commit if changes detected
        git add README.md CHANGELOG.md
        if git diff --staged --quiet; then
          echo "No documentation changes needed."
        else
          git commit -m "docs: update release timestamp and changelog"
          git push origin securite
        fi

    - name: Check if PR already exists
      id: check-pr
      run: |
        # Get list of open PRs from securite to master
        PR_COUNT=$(gh pr list --base master --head securite --state open --json number | jq 'length')
        echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create PR from securite to master
      if: steps.check-pr.outputs.pr_count == '0'
      run: |
        git config --global user.name 'EthanThePhoenix38'
        git config --global user.email '${{ secrets.GIT_AUTHOR_EMAIL }}'

        # Check if there are new commits on securite not in master
        NEW_COMMITS=$(git log master..securite --oneline | wc -l)

        if [ "$NEW_COMMITS" -gt 0 ]; then
          gh pr create \
            --base master \
            --head securite \
            --title "chore: dependency updates" \
            --body "Automated dependency and package updates from automated tools.

            ## Changes
            This PR includes automatic dependency updates validated in the securite branch.

            ## Security
            All dependency updates have been vetted for security vulnerabilities.

            ## Testing
            - [ ] Dependencies properly installed
            - [ ] No breaking changes detected
            - [ ] Application runs without errors" \
            --label "dependencies" \
            --label "automated" || echo "PR already exists"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-interdependencies:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.pull_request.labels.*.name, 'dependencies') || startsWith(github.head_ref, 'dependabot/') }}
    outputs:
      should_merge: ${{ steps.outcome.outputs.result }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Auto-Correction & Validation (Install & Build)
      id: validate
      continue-on-error: true
      run: |
        npm install --prefer-offline --no-audit
        npm run build

    - name: Enforce Silent Correction
      id: outcome
      if: always()
      run: |
        if [ "${{ steps.validate.outcome }}" == "failure" ]; then
          echo "::notice::Validation failed. Auto-correcting by rejecting PR."
          # Auto-correct: Close the PR to keep the ecosystem clean. 
          # Use label to track the unpatched vulnerability silently.
          if [ "${{ github.event.pull_request.number }}" != "" ]; then
             gh pr edit ${{ github.event.pull_request.number }} --add-label "skipped-vulnerability"
             gh pr close ${{ github.event.pull_request.number }} --comment "ðŸš« **Auto-Correction**: Build validation failed. Closing PR to prevent regression. Dependabot will ignore this specific version." --delete-branch || true
          fi
          echo "result=false" >> $GITHUB_OUTPUT
        else
          echo "result=true" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
